<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Free Browser AI Agent</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #020617;
        color: #e2e8f0;
        display: flex;
        justify-content: center;
        padding: 28px 12px 100px;
      }
      .app {
        width: min(900px, 100%);
        background: rgba(2, 6, 23, 0.5);
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 16px;
        padding: 20px 20px 26px;
      }
      h1 {
        font-size: 1.4rem;
        margin-bottom: 6px;
      }
      .hint {
        color: #94a3b8;
        margin-bottom: 14px;
      }
      .row {
        display: flex;
        gap: 8px;
      }
      input[type="text"] {
        flex: 1;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(15, 23, 42, 0.4);
        color: #e2e8f0;
      }
      button {
        background: #38bdf8;
        border: none;
        padding: 0 16px;
        border-radius: 10px;
        font-weight: 600;
        color: #020617;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .panel {
        margin-top: 14px;
        background: rgba(15, 23, 42, 0.45);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 14px;
        padding: 10px 12px 12px;
      }
      .label {
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.06rem;
        color: #94a3b8;
        margin-bottom: 4px;
      }
      pre {
        background: rgba(15, 23, 42, 0.3);
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 0.7rem;
        overflow-x: auto;
      }
      .answer {
        font-size: 1rem;
      }
      .warn {
        color: #f97316;
        font-size: 0.7rem;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <h1>Free Browser AI Agent</h1>
      <p class="hint">
        Try: <b>weather in Mumbai</b>, <b>temperature in Toronto</b>, or <b>btc price</b>. Runs fully in your browser using
        WebLLM. Model files come from the public MLC CDN. :contentReference[oaicite:1]{index=1}
      </p>

      <div class="row">
        <input id="user-input" type="text" placeholder="Ask me…" />
        <button id="run-btn">Run</button>
      </div>

      <p class="warn" id="status">loading model engine…</p>

      <div class="panel" id="thinking-panel" style="display:none;">
        <div class="label">LLM decision</div>
        <pre id="thinking"></pre>
      </div>

      <div class="panel" id="result-panel" style="display:none;">
        <div class="label">Answer</div>
        <div class="answer" id="answer"></div>
      </div>
    </div>

    <script type="module">
      // 1. load WebLLM from CDN (free)  :contentReference[oaicite:2]{index=2}
      import * as webllm from "https://esm.run/@mlc-ai/web-llm";

      const statusEl = document.getElementById("status");
      const inputEl = document.getElementById("user-input");
      const runBtn = document.getElementById("run-btn");
      const thinkingPanel = document.getElementById("thinking-panel");
      const thinkingEl = document.getElementById("thinking");
      const resultPanel = document.getElementById("result-panel");
      const answerEl = document.getElementById("answer");

      // choose a smallish model from the public list (works on more machines) :contentReference[oaicite:3]{index=3}
      const modelId = "SmolLM2-360M-Instruct-q4f16_1-MLC";

      // create engine
      const engine = await webllm.CreateMLCEngine(
        { model: modelId },
        {
          initProgressCallback: (report) => {
            statusEl.textContent = "model: " + report.text;
          },
        },
      );

      statusEl.textContent = "model ready.";

      // ---- tools ----
      async function weatherTool(locationName) {
        const geoUrl =
          "https://geocoding-api.open-meteo.com/v1/search?name=" +
          encodeURIComponent(locationName) +
          "&count=1&language=en&format=json";
        const geoRes = await fetch(geoUrl);
        const geo = await geoRes.json();
        if (!geo.results || !geo.results.length) throw new Error("place not found");
        const { latitude, longitude, name, country } = geo.results[0];
        const wUrl =
          `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}` +
          "&current=temperature_2m,apparent_temperature,weather_code&timezone=auto";
        const wRes = await fetch(wUrl);
        const w = await wRes.json();
        return {
          place: `${name}, ${country}`,
          temp: w.current.temperature_2m,
          feels: w.current.apparent_temperature,
        };
      }

      async function btcTool() {
        const r = await fetch("https://api.coindesk.com/v1/bpi/currentprice.json");
        const d = await r.json();
        return { usd: d.bpi.USD.rate, time: d.time.updated };
      }

      async function runAgent() {
        const text = inputEl.value.trim();
        if (!text) return;

        runBtn.disabled = true;
        thinkingPanel.style.display = "block";
        resultPanel.style.display = "none";
        thinkingEl.textContent = "thinking…";

        // 2. ask the LOCAL LLM which tool to call
        const prompt = `
You are a tool router. You must ALWAYS answer valid JSON.
Tools:
1) "weather" -> when user asks about weather, temp, forecast, cold, hot, rain, city, location.
   Needs field: "location".
2) "btc" -> when user asks about bitcoin, btc, crypto price.
3) "unknown" -> otherwise.

Return ONLY JSON. Examples:
{"tool":"weather","location":"Delhi"}
{"tool":"btc"}
{"tool":"unknown"}

User query: "${text}"
Answer:
        `.trim();

        const reply = await engine.chat.completions.create({
          messages: [
            { role: "system", content: "You route to tools and output JSON only." },
            { role: "user", content: prompt },
          ],
          model: modelId,
          stream: false,
          temperature: 0,
        });

        const llmOut = reply.choices[0].message.content.trim();
        thinkingEl.textContent = llmOut;

        let decision;
        try {
          decision = JSON.parse(llmOut);
        } catch (e) {
          answerEl.textContent = "LLM did not return JSON. You can still ask again.";
          resultPanel.style.display = "block";
          runBtn.disabled = false;
          return;
        }

        // 3. call the tool the LLM picked
        try {
          if (decision.tool === "weather") {
            const loc = decision.location || "Delhi";
            const w = await weatherTool(loc);
            answerEl.textContent = `Weather in ${w.place}: ${w.temp}°C (feels ${w.feels}°C).`;
          } else if (decision.tool === "btc") {
            const b = await btcTool();
            answerEl.textContent = `BTC price: $${b.usd} (as of ${b.time}).`;
          } else {
            answerEl.textContent = "I don’t have a tool for that yet.";
          }
        } catch (err) {
          answerEl.textContent = "Tool error: " + err.message;
        }

        resultPanel.style.display = "block";
        runBtn.disabled = false;
      }

      runBtn.addEventListener("click", runAgent);
      inputEl.addEventListener("keydown", (e) => e.key === "Enter" && runAgent());
    </script>
  </body>
</html>
