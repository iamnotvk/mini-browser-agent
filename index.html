<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Browser AI Agent (OpenRouter Llama 3.3 8B Free)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #020617;
        color: #e2e8f0;
        display: flex;
        justify-content: center;
        padding: 32px 12px 100px;
      }
      .app {
        width: min(900px, 100%);
        background: rgba(2, 6, 23, 0.5);
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 16px;
        padding: 20px 20px 26px;
      }
      h1 {
        font-size: 1.3rem;
        margin-bottom: 6px;
      }
      .hint {
        color: #94a3b8;
        margin-bottom: 14px;
      }
      .row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      input[type="text"],
      input[type="password"] {
        flex: 1;
        padding: 9px 12px;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(15, 23, 42, 0.4);
        color: #e2e8f0;
      }
      button {
        background: #38bdf8;
        border: none;
        padding: 0 16px;
        border-radius: 10px;
        font-weight: 600;
        color: #020617;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .panel {
        margin-top: 14px;
        background: rgba(15, 23, 42, 0.45);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 14px;
        padding: 10px 12px 12px;
      }
      .label {
        font-size: 0.65rem;
        text-transform: uppercase;
        color: #94a3b8;
        margin-bottom: 4px;
      }
      pre {
        background: rgba(15, 23, 42, 0.3);
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 0.7rem;
        overflow-x: auto;
      }
      .answer {
        font-size: 1rem;
      }
      .warn {
        color: #f97316;
        font-size: 0.7rem;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <h1>Browser AI Agent</h1>
      <p class="hint">
        1) Paste your <b>OpenRouter API key</b> (it stays here). 2) Ask: <b>weather in Mumbai</b> or <b>btc price</b>. The agent
        will call <code>meta-llama/llama-3.3-8b-instruct:free</code> to pick the tool, then call real APIs.
      </p>

      <!-- 1) key -->
      <div class="row">
        <input id="api-key" type="password" placeholder="OpenRouter API key (sk-or-...)" />
      </div>

      <!-- 2) user query -->
      <div class="row">
        <input id="user-input" type="text" placeholder="Ask me…" />
        <button id="run-btn">Run</button>
      </div>

      <p class="warn" id="status">Idle.</p>

      <div class="panel" id="thinking-panel" style="display:none;">
        <div class="label">LLM decision (raw)</div>
        <pre id="thinking"></pre>
      </div>

      <div class="panel" id="result-panel" style="display:none;">
        <div class="label">Answer</div>
        <div class="answer" id="answer"></div>
      </div>
    </div>

    <script>
      const keyEl = document.getElementById("api-key");
      const inputEl = document.getElementById("user-input");
      const runBtn = document.getElementById("run-btn");
      const statusEl = document.getElementById("status");
      const thinkingPanel = document.getElementById("thinking-panel");
      const thinkingEl = document.getElementById("thinking");
      const resultPanel = document.getElementById("result-panel");
      const answerEl = document.getElementById("answer");

      // ---- tools ----
      async function weatherTool(locationName) {
        const geo = await fetch(
          "https://geocoding-api.open-meteo.com/v1/search?name=" +
            encodeURIComponent(locationName) +
            "&count=1&language=en&format=json",
        ).then((r) => r.json());
        if (!geo.results || !geo.results.length) throw new Error("place not found");
        const { latitude, longitude, name, country } = geo.results[0];
        const w = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,apparent_temperature&timezone=auto`,
        ).then((r) => r.json());
        return {
          place: `${name}, ${country}`,
          temp: w.current.temperature_2m,
          feels: w.current.apparent_temperature,
        };
      }

      async function btcTool() {
        const d = await fetch("https://api.coindesk.com/v1/bpi/currentprice.json").then((r) => r.json());
        return { usd: d.bpi.USD.rate, time: d.time.updated };
      }

      // ---- call OpenRouter with Llama 3.3 8B free ----
      async function askOpenRouter(apiKey, userText) {
        const body = {
          model: "meta-llama/llama-3.3-8b-instruct:free",
          messages: [
            {
              role: "system",
              content:
                'You are a tool router. Reply with JSON ONLY. Tools: weather(location), btc, unknown. Examples: {"tool":"weather","location":"Delhi"}, {"tool":"btc"}, {"tool":"unknown"}',
            },
            { role: "user", content: userText },
          ],
          temperature: 0,
          max_tokens: 200,
        };

        const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            Authorization: "Bearer " + apiKey,
            "Content-Type": "application/json",
            // optional but nice
            "HTTP-Referer": "https://example.com/",
            "X-Title": "mini-browser-agent",
          },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error("OpenRouter error: " + txt);
        }

        const data = await res.json();
        return data.choices[0].message.content.trim();
      }

      async function runAgent() {
        const apiKey = keyEl.value.trim();
        const text = inputEl.value.trim();
        if (!apiKey) {
          alert("Paste your OpenRouter key first.");
          return;
        }
        if (!text) return;

        runBtn.disabled = true;
        statusEl.textContent = "contacting model…";
        thinkingPanel.style.display = "block";
        thinkingEl.textContent = "";
        resultPanel.style.display = "none";

        try {
          const llmOut = await askOpenRouter(apiKey, text);
          thinkingEl.textContent = llmOut;

          let decision;
          try {
            decision = JSON.parse(llmOut);
          } catch (e) {
            answerEl.textContent = "Model didn't return JSON. Try a simpler query.";
            resultPanel.style.display = "block";
            statusEl.textContent = "done (but JSON parse failed).";
            return;
          }

          if (decision.tool === "weather") {
            const w = await weatherTool(decision.location || "Delhi");
            answerEl.textContent = `Weather in ${w.place}: ${w.temp}°C (feels ${w.feels}°C).`;
          } else if (decision.tool === "btc") {
            const b = await btcTool();
            answerEl.textContent = `BTC price: $${b.usd} (as of ${b.time}).`;
          } else {
            answerEl.textContent = "I don't have a tool for that yet.";
          }

          resultPanel.style.display = "block";
          statusEl.textContent = "done.";
        } catch (err) {
          statusEl.textContent = err.message;
        } finally {
          runBtn.disabled = false;
        }
      }

      runBtn.addEventListener("click", runAgent);
      inputEl.addEventListener("keydown", (e) => e.key === "Enter" && runAgent());
    </script>
  </body>
</html>
